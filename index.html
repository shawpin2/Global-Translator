<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Translator</title>
    
    <!-- All styles are embedded here for offline support -->
    <style>
        /* Google Fonts: Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom CSS Variables for Theming */
        :root {
            --bg-primary-light: #f3f4f6; /* gray-100 */
            --bg-secondary-light: #ffffff; /* white */
            --bg-tertiary-light: #e5e7eb; /* gray-200 */
            --text-primary-light: #111827; /* gray-900 */
            --text-secondary-light: #6b7280; /* gray-500 */
            --accent-color: #0891b2; /* cyan-600 */
            --accent-hover: #06b6d4; /* cyan-500 */
            --border-color-light: #d1d5db; /* gray-300 */
            --shadow-color: rgba(8, 145, 178, 0.2);
        }

        .dark {
            --bg-primary-light: #030712; /* gray-950 */
            --bg-secondary-light: #111827; /* gray-900 */
            --bg-tertiary-light: #1f2937; /* gray-800 */
            --text-primary-light: #f9fafb; /* gray-50 */
            --text-secondary-light: #9ca3af; /* gray-400 */
            --border-color-light: #374151; /* gray-700 */
            --shadow-color: rgba(8, 145, 178, 0.25);
        }

        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary-light);
            color: var(--text-primary-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            /* STICKY FIX: Prevents the background from scrolling */
            overflow: hidden;
        }

        /* Main Container: Smartphone Mockup */
        .phone-container {
            width: 100%;
            max-width: 24rem; /* 384px */
            height: 90vh;
            max-height: 46rem; /* 736px */
            background-color: var(--bg-secondary-light);
            border-radius: 2.5rem; /* 40px */
            box-shadow: 0 0 40px var(--shadow-color);
            border: 4px solid #000;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar, .modal-body::-webkit-scrollbar { width: 5px; }
        textarea::-webkit-scrollbar-track, .modal-body::-webkit-scrollbar-track { background: var(--bg-secondary-light); }
        textarea::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover, .modal-body::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Toast Animation */
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
        .toast-animate { animation: fadeInOut 3s ease-in-out forwards; }
        
        /* --- CLICK/TOUCH ANIMATION --- */
        .clickable { transition: transform 0.1s ease; }
        .clickable:active { transform: scale(0.92); }

        /* Icon Animation */
        @keyframes rotate-in { from { transform: rotate(-360deg) scale(0.5); opacity: 0; } to { transform: rotate(0deg) scale(1); opacity: 1; } }
        .animate-history-icon { animation: rotate-in 0.4s ease-out; }

        /* Utility Classes (inspired by Tailwind) */
        .flex { display: flex; } .items-center { align-items: center; } .justify-center { justify-content: center; } .justify-between { justify-content: space-between; } .flex-col { flex-direction: column; } .flex-grow { flex-grow: 1; } .w-full { width: 100%; } .min-h-screen { min-height: 100vh; } .p-4 { padding: 1rem; } .mt-4 { margin-top: 1rem; } .mt-3 { margin-top: 0.75rem; } .mt-2 { margin-top: 0.5rem; } .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; } .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; } .relative { position: relative; } .absolute { position: absolute; } .inset-0 { top: 0; right: 0; bottom: 0; left: 0; } .bottom-5 { bottom: 1.25rem; } .left-1\/2 { left: 50%; } .-translate-x-1\/2 { transform: translateX(-50%); } .overflow-hidden { overflow: hidden; } .text-center { text-align: center; } .font-bold { font-weight: 700; } .pointer-events-none { pointer-events: none; } .cursor-pointer { cursor: pointer; } .resize-none { resize: none; } .rounded-xl { border-radius: 0.75rem; } .p-2 { padding: 0.5rem; } .hidden { display: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Component Styles */
        .header { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; padding-left: 1rem; padding-right: 1rem;}
        .header-text { text-align: center; flex-grow: 1; }
        .header h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; }
        .header p { color: var(--text-secondary-light); font-size: 0.875rem; transition: color 0.3s ease; }
        .lang-selector-ui { background-color: var(--bg-tertiary-light); padding: 0.5rem; border-radius: 0.75rem; transition: background-color 0.3s ease;}
        .lang-btn { background-color: var(--bg-secondary-light); color: var(--text-primary-light); border: 1px solid var(--border-color-light); border-radius: 0.5rem; padding: 0.75rem 0.5rem; width: 42%; transition: all 0.3s ease; text-align: center; font-weight: 500; }
        .icon-btn { background-color: transparent; padding: 0.5rem; border-radius: 9999px; transition: all 0.3s ease; border: none; cursor: pointer; display: inline-flex; justify-content: center; align-items: center;}
        .icon-btn:hover { background-color: var(--bg-tertiary-light); }
        .icon-btn svg { color: var(--text-primary-light); }
        .text-area-container { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-tertiary-light); border-radius: 0.75rem; padding: 0.75rem; transition: background-color 0.3s ease; }
        textarea { flex-grow: 1; width: 100%; background: transparent; color: var(--text-primary-light); resize: none; border: none; outline: none; transition: color 0.3s ease; font-size: 1rem; }
        textarea::placeholder { color: var(--text-secondary-light); transition: color 0.3s ease;}
        .char-count { font-size: 0.75rem; color: var(--text-secondary-light); transition: color 0.3s ease; }
        .small-icon-btn { background: transparent; padding: 0.5rem; border-radius: 9999px; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .small-icon-btn:hover { background-color: rgba(128,128,128,0.2); }
        .small-icon-btn svg { color: var(--text-secondary-light); }
        .translate-btn { width: 100%; background-image: linear-gradient(to right, var(--accent-color), var(--accent-hover)); color: white; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.75rem; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(8, 145, 178, 0.5); }
        .translate-btn:hover { background-position: right center; transform: translateY(-1px); box-shadow: 0 6px 20px 0 rgba(8, 145, 178, 0.4); }
        .toast { position: absolute; bottom: 1.25rem; left: 50%; transform: translateX(-50%); background-color: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; opacity: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 100;}
        
        /* --- MODAL STYLES (for History and Language) --- */
        .modal-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 40; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;}
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { position: absolute; bottom: 0; left: 0; right: 0; max-height: 85%; background-color: var(--bg-secondary-light); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; z-index: 50; padding: 1rem; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.open { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color-light); }
        .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
        .modal-header button { color: var(--accent-hover); background: transparent; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-top: 0.75rem; }
        
        /* History Modal Specifics */
        .history-item { padding: 0.75rem; border-bottom: 1px solid var(--border-color-light); cursor: pointer; }
        .history-item:hover { background-color: var(--bg-tertiary-light); }
        .history-item-langs { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary-light); margin-bottom: 0.25rem; }
        .history-item p { margin: 0; font-size: 1rem; }
        .history-item .source-text { font-weight: 500; }
        
        /* Language Modal Specifics */
        #lang-search { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color-light); background-color: var(--bg-tertiary-light); color: var(--text-primary-light); margin-bottom: 0.75rem; }
        .lang-item { padding: 0.85rem 0.5rem; border-bottom: 1px solid var(--border-color-light); cursor: pointer; font-size: 1rem; }
        .lang-item:hover { background-color: var(--bg-tertiary-light); }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="phone-container">
        
        <header class="header">
            <button id="history-btn" class="icon-btn clickable" title="Translation History">
                <!-- NEW HISTORY ICON -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 8v4l3 3"/>
                    <path d="M22 12A10 10 0 1 1 12 2a10 10 0 0 1 10 10z"/>
                    <path d="m12 5.26-2.5 3.13L7 7"/>
                </svg>
            </button>
            <div class="header-text">
                <h1>Global Translator</h1>
                <p>Your Language, Your World</p>
            </div>
            <button id="theme-toggle-btn" class="icon-btn clickable" title="Toggle Theme">
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <main class="flex-grow flex flex-col mt-4 overflow-hidden">
            <!-- NEW LANGUAGE SELECTOR UI -->
            <div class="flex items-center justify-between lang-selector-ui">
                <button id="source-lang-btn" class="lang-btn clickable">Auto Detect</button>
                <button id="swap-btn" class="icon-btn clickable">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5m14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5"/>
                    </svg>
                </button>
                <button id="target-lang-btn" class="lang-btn clickable">Hindi</button>
            </div>

            <div class="flex-grow flex flex-col mt-3 space-y-3 overflow-hidden">
                <div class="text-area-container">
                    <textarea id="source-text" placeholder="Enter text here..."></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <span id="source-char-count" class="char-count">0/5000</span>
                        <div class="flex space-x-2">
                            <button id="paste-btn" class="small-icon-btn clickable" title="Paste">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                            </button>
                            <button id="copy-source-btn" class="small-icon-btn clickable" title="Copy">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                             <button id="clear-btn" class="small-icon-btn clickable" title="Clear">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-area-container">
                     <div id="target-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span id="loading-spinner" class="hidden">
                            <svg class="animate-spin" style="margin-right: 0.75rem;" height="20" width="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span id="placeholder-text" style="color: var(--text-secondary-light); font-size: 1.125rem;"></span>
                    </div>
                    <textarea id="target-text" readonly></textarea>
                    <div class="flex items-center justify-end mt-2">
                        <button id="copy-target-btn" class="small-icon-btn clickable" title="Copy Translated Text">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button id="translate-btn" class="translate-btn clickable">Translate</button>
            </div>
        </main>
        
        <div id="toast" class="toast">Text copied!</div>
        
        <!-- MODALS (History and Language) -->
        <div id="modal-overlay" class="modal-overlay"></div>
        
        <div id="history-modal" class="modal">
            <div class="modal-header">
                <h2>Translation History</h2>
                <button id="clear-history-btn" class="clickable">Clear</button>
            </div>
            <div id="history-modal-body" class="modal-body"></div>
        </div>

        <div id="lang-modal" class="modal">
            <div class="modal-header">
                <h2 id="lang-modal-title">Select Language</h2>
                <button id="close-lang-modal-btn" class="clickable">Close</button>
            </div>
            <div class="modal-body">
                <input type="text" id="lang-search" placeholder="Search for a language...">
                <div id="lang-list"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element selections
            const sourceLangBtn = document.getElementById('source-lang-btn');
            const targetLangBtn = document.getElementById('target-lang-btn');
            const sourceText = document.getElementById('source-text');
            const targetText = document.getElementById('target-text');
            const swapBtn = document.getElementById('swap-btn');
            const sourceCharCount = document.getElementById('source-char-count');
            const clearBtn = document.getElementById('clear-btn');
            const copySourceBtn = document.getElementById('copy-source-btn');
            const copyTargetBtn = document.getElementById('copy-target-btn');
            const pasteBtn = document.getElementById('paste-btn');
            const toast = document.getElementById('toast');
            const translateBtn = document.getElementById('translate-btn');
            const targetPlaceholder = document.getElementById('target-placeholder');
            const loadingSpinner = document.getElementById('loading-spinner');
            const placeholderText = document.getElementById('placeholder-text');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIconMoon = document.getElementById('theme-icon-moon');
            const themeIconSun = document.getElementById('theme-icon-sun');
            const modalOverlay = document.getElementById('modal-overlay');

            // History Modal Elements
            const historyBtn = document.getElementById('history-btn');
            const historyModal = document.getElementById('history-modal');
            const historyModalBody = document.getElementById('history-modal-body');
            const clearHistoryBtn = document.getElementById('clear-history-btn');

            // Language Modal Elements
            const langModal = document.getElementById('lang-modal');
            const langModalTitle = document.getElementById('lang-modal-title');
            const closeLangModalBtn = document.getElementById('close-lang-modal-btn');
            const langSearch = document.getElementById('lang-search');
            const langList = document.getElementById('lang-list');
            
            // State
            let currentSourceLang = 'auto';
            let currentTargetLang = 'hi';
            let lastDetectedLang = 'en';
            let currentLangSelectionMode = 'source'; // 'source' or 'target'

            const languages = { "auto": "Auto Detect", "af": "Afrikaans", "sq": "Albanian", "ar": "Arabic", "hy": "Armenian", "az": "Azerbaijani", "eu": "Basque", "be": "Belarusian", "bn": "Bengali", "bs": "Bosnian", "bg": "Bulgarian", "ca": "Catalan", "ceb": "Cebuano", "ny": "Chichewa", "zh-CN": "Chinese (Simplified)", "zh-TW": "Chinese (Traditional)", "co": "Corsican", "hr": "Croatian", "cs": "Czech", "da": "Danish", "nl": "Dutch", "en": "English", "eo": "Esperanto", "et": "Estonian", "tl": "Filipino", "fi": "Finnish", "fr": "French", "fy": "Frisian", "gl": "Galician", "ka": "Georgian", "de": "German", "el": "Greek", "gu": "Gujarati", "ht": "Haitian Creole", "ha": "Hausa", "haw": "Hawaiian", "iw": "Hebrew", "he": "Hebrew", "hi": "Hindi", "hmn": "Hmong", "hu": "Hungarian", "is": "Icelandic", "ig": "Igbo", "id": "Indonesian", "ga": "Irish", "it": "Italian", "ja": "Japanese", "jw": "Javanese", "kn": "Kannada", "kk": "Kazakh", "km": "Khmer", "ko": "Korean", "ku": "Kurdish (Kurmanji)", "ky": "Kyrgyz", "lo": "Lao", "la": "Latin", "lv": "Latvian", "lt": "Lithuanian", "lb": "Luxembourgish", "mk": "Macedonian", "mg": "Malagasy", "ms": "Malay", "ml": "Malayalam", "mt": "Maltese", "mi": "Maori", "mr": "Marathi", "mn": "Mongolian", "my": "Myanmar (Burmese)", "ne": "Nepali", "no": "Norwegian", "or": "Odia", "ps": "Pashto", "fa": "Persian", "pl": "Polish", "pt": "Portuguese", "pa": "Punjabi", "ro": "Romanian", "ru": "Russian", "sm": "Samoan", "gd": "Scots Gaelic", "sr": "Serbian", "st": "Sesotho", "sn": "Shona", "sd": "Sindhi", "si": "Sinhala", "sk": "Slovak", "sl": "Slovenian", "so": "Somali", "es": "Spanish", "su": "Sundanese", "sw": "Swahili", "sv": "Swedish", "tg": "Tajik", "ta": "Tamil", "te": "Telugu", "th": "Thai", "tr": "Turkish", "uk": "Ukrainian", "ur": "Urdu", "ug": "Uyghur", "uz": "Uzbek", "vi": "Vietnamese", "cy": "Welsh", "xh": "Xhosa", "yi": "Yiddish", "yo": "Yoruba", "zu": "Zulu" };

            // --- Theme Toggler ---
            const docElement = document.documentElement;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            docElement.classList.add(savedTheme);
            themeIconMoon.classList.toggle('hidden', savedTheme === 'light');
            themeIconSun.classList.toggle('hidden', savedTheme !== 'light');
            themeToggleBtn.addEventListener('click', () => {
                const isDark = docElement.classList.toggle('dark');
                docElement.classList.toggle('light', !isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                themeIconMoon.classList.toggle('hidden');
                themeIconSun.classList.toggle('hidden');
            });

            // --- Event Listeners ---
            sourceText.addEventListener('input', () => sourceCharCount.textContent = `${sourceText.value.length}/5000`);
            translateBtn.addEventListener('click', translateText);
            
            swapBtn.addEventListener('click', () => {
                const tempLangCode = currentSourceLang;
                const tempLangName = sourceLangBtn.textContent;
                const tempText = sourceText.value;

                currentSourceLang = currentTargetLang;
                sourceLangBtn.textContent = targetLangBtn.textContent;
                
                currentTargetLang = (tempLangCode !== 'auto') ? tempLangCode : lastDetectedLang;
                targetLangBtn.textContent = (tempLangCode !== 'auto') ? tempLangName : languages[lastDetectedLang];

                sourceText.value = targetText.value;
                targetText.value = tempText;
                sourceCharCount.textContent = `${sourceText.value.length}/5000`;
                
                if (sourceText.value.trim()) translateText();
                else clearBtn.click();
            });

            clearBtn.addEventListener('click', () => {
                sourceText.value = '';
                targetText.value = '';
                sourceCharCount.textContent = '0/5000';
                targetPlaceholder.style.display = 'flex';
                placeholderText.textContent = 'Translation will appear here';
            });
            
            pasteBtn.addEventListener('click', () => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.readText().then(text => {
                        sourceText.value = text;
                        sourceCharCount.textContent = `${text.length}/5000`;
                        showToast('Pasted from clipboard!');
                    }).catch(err => showToast('Could not paste text.', 'error'));
                } else {
                    showToast('Paste feature requires a secure connection (HTTPS).', 'error');
                }
            });

            copySourceBtn.addEventListener('click', () => copyToClipboard(sourceText.value, 'Source text copied!'));
            copyTargetBtn.addEventListener('click', () => copyToClipboard(targetText.value, 'Translated text copied!'));

            // --- Core Translation Function ---
            function translateText() {
                if (!navigator.onLine) {
                    showToast('Please connect to the internet to translate.', 'error');
                    return;
                }
                const text = sourceText.value.trim();
                if (!text) {
                    clearBtn.click();
                    return;
                }
                setLoadingState(true);
                const apiUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${currentSourceLang}&tl=${currentTargetLang}&dt=t&q=${encodeURIComponent(text)}`;

                fetch(apiUrl)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data[0] && data[0][0] && data[0][0][0]) {
                            const translated = data[0].map(segment => segment[0]).join('');
                            targetText.value = translated;
                            lastDetectedLang = data[2] || lastDetectedLang;
                            saveTranslationToHistory(text, translated, currentSourceLang === 'auto' ? lastDetectedLang : currentSourceLang, currentTargetLang);
                        } else {
                           placeholderText.textContent = 'Error during translation.';
                           targetText.value = '';
                        }
                    })
                    .catch(() => placeholderText.textContent = 'Network error. Please try again.')
                    .finally(() => setLoadingState(false));
            }

            function setLoadingState(isLoading) {
                loadingSpinner.classList.toggle('hidden', !isLoading);
                placeholderText.textContent = isLoading ? 'Translating...' : '';
                targetPlaceholder.style.display = (isLoading || !targetText.value) ? 'flex' : 'none';
            }
            
            function copyToClipboard(text, message) {
                if (!text) return;
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => showToast(message))
                    .catch(() => showToast('Copy failed!', 'error'));
                } else {
                    showToast('Copy feature requires a secure connection (HTTPS).', 'error');
                }
            }

            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#22c55e';
                toast.classList.add('toast-animate');
                setTimeout(() => toast.classList.remove('toast-animate'), 3000);
            }

            // --- Modal Opening/Closing Logic ---
            function openModal(modal) {
                modalOverlay.classList.add('open');
                modal.classList.add('open');
            }

            function closeModal() {
                modalOverlay.classList.remove('open');
                document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));
            }
            modalOverlay.addEventListener('click', closeModal);

            // --- History Modal Logic ---
            historyBtn.addEventListener('click', () => {
                const icon = historyBtn.querySelector('svg');
                icon.classList.remove('animate-history-icon');
                void icon.offsetWidth; // Trigger reflow
                icon.classList.add('animate-history-icon');
                renderHistory();
                openModal(historyModal);
            });
            clearHistoryBtn.addEventListener('click', () => {
                localStorage.removeItem('translationHistory');
                renderHistory();
                showToast('History cleared!');
            });
            function getHistory() { return JSON.parse(localStorage.getItem('translationHistory')) || []; }
            function saveTranslationToHistory(source, target, sl, tl) {
                const history = getHistory();
                if (history.length > 0 && history[0].source === source && history[0].target === target) return;
                const newEntry = { source, target, sl, tl, date: new Date().toISOString() };
                const updatedHistory = [newEntry, ...history].slice(0, 100);
                localStorage.setItem('translationHistory', JSON.stringify(updatedHistory));
            }
            function renderHistory() {
                const history = getHistory();
                historyModalBody.innerHTML = '';
                if (history.length === 0) {
                    historyModalBody.innerHTML = '<p style="text-align:center; color: var(--text-secondary-light); padding: 1rem;">No history yet.</p>';
                    return;
                }
                history.forEach(item => {
                    const historyItemDiv = document.createElement('div');
                    historyItemDiv.className = 'history-item';
                    historyItemDiv.innerHTML = `
                        <div class="history-item-langs">${languages[item.sl] || 'Unknown'} → ${languages[item.tl] || 'Unknown'}</div>
                        <p class="source-text">${item.source}</p>
                    `;
                    historyItemDiv.addEventListener('click', () => {
                        sourceText.value = item.source;
                        targetText.value = item.target;
                        currentSourceLang = item.sl;
                        currentTargetLang = item.tl;
                        sourceLangBtn.textContent = languages[item.sl];
                        targetLangBtn.textContent = languages[item.tl];
                        sourceCharCount.textContent = `${item.source.length}/5000`;
                        targetPlaceholder.style.display = 'none';
                        closeModal();
                    });
                    historyModalBody.appendChild(historyItemDiv);
                });
            }

            // --- Language Modal Logic ---
            sourceLangBtn.addEventListener('click', () => { currentLangSelectionMode = 'source'; openLangModal(); });
            targetLangBtn.addEventListener('click', () => { currentLangSelectionMode = 'target'; openLangModal(); });
            closeLangModalBtn.addEventListener('click', closeModal);
            langSearch.addEventListener('input', (e) => populateLangList(e.target.value));

            function openLangModal() {
                langModalTitle.textContent = `Select ${currentLangSelectionMode} language`;
                populateLangList();
                openModal(langModal);
                langSearch.focus();
            }

            function populateLangList(filter = '') {
                langList.innerHTML = '';
                const filteredLangs = Object.entries(languages).filter(([code, name]) => {
                    if (currentLangSelectionMode === 'target' && code === 'auto') return false;
                    return name.toLowerCase().includes(filter.toLowerCase());
                });

                filteredLangs.forEach(([code, name]) => {
                    const langItemDiv = document.createElement('div');
                    langItemDiv.className = 'lang-item';
                    langItemDiv.textContent = name;
                    langItemDiv.dataset.code = code;
                    langItemDiv.addEventListener('click', () => {
                        if (currentLangSelectionMode === 'source') {
                            currentSourceLang = code;
                            sourceLangBtn.textContent = name;
                        } else {
                            currentTargetLang = code;
                            targetLangBtn.textContent = name;
                        }
                        closeModal();
                    });
                    langList.appendChild(langItemDiv);
                });
            }
        });
    </script>
</body>
</html>